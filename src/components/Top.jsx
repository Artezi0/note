import { collection, addDoc } from 'firebase/firestore'
import ReactTooltip from 'react-tooltip'
import React, { useState } from 'react'
import FileSaver from 'file-saver'

import { db } from '../firebase'
import { UserAuth } from '../context/AuthContext'

import '../styles/app.scss'

export default function Top({ handleSide, sidebar, isRead, read,  }) {
  const [ submenu, isSubmenu ] = useState(false)
  const { active, getActive, user } = UserAuth()

  let filenameStyle = undefined
  let filename = undefined 

  function handleStyle() {
    if (active) {
      if (getActive().title.length > 20) {
        filename = getActive().title.slice(0, 20) + '...' 
        document.title = getActive().title.slice(0, 20) + '... - Notebucket'
      } else {
        filename = getActive().title
        document.title = getActive().title + ' - Notebucket'
      }

      filenameStyle = { color: '#000000' }
    } else if (!active) {
      filename = 'No selected'
      filenameStyle = { 
        color: '#19171199',
        pointerEvents: 'none',
      }
    }

    return filename && filenameStyle
  }
  handleStyle()

  const Submenu = () => {
    function handleImport() {
      let blob = document.getElementById('importFile').files[0];
      let reader = new FileReader()
      let textFile = /text.plain.*/
      
      if (blob.type.match(textFile)) {
        reader.onload = async function(e) {
          let newNote = {
            title: blob.name.replace(/\.[^.$]+$/, ''),
            body: e.target.result,
            lastModified: Date.now(),
            cover: {
              isCover: false,
              value: '#E8E7E3'
            },
            stats: ''
          }
    
          await addDoc(collection(db, user.uid), newNote)
        }
      }

      reader.readAsText(blob)
      isSubmenu(false)
    }
    
  
    function handleExport() {
      let blob = new Blob([getActive().body], {type: 'text/plain;charset=utf-8'})
      
      FileSaver.saveAs(blob, `${getActive().title}.txt`)
      isSubmenu(false)
    }
  
    return (
      <div className='submenu'>
        <h3 className='submenu__title'>Options</h3>
        <ul className='submenu__actions'>
          <div className='submenu__actions-import'>
            <label htmlFor='importFile'>
              <svg width='10' height='14' viewBox='0 0 14 18' fill='none' xmlns='http://www.w3.org/2000/svg'>
                <path d='M7 0.313477C6.41992 0.313477 6.01562 0.717773 6.01562 1.29785V12.1523L6.09473 14.0596L3.80957 11.5107L1.81445 9.52441C1.63867 9.34863 1.39258 9.23438 1.11133 9.23438C0.575195 9.23438 0.179688 9.63867 0.179688 10.1924C0.179688 10.4473 0.276367 10.6846 0.487305 10.8955L6.27051 16.6963C6.46387 16.8984 6.72754 17.0039 7 17.0039C7.26367 17.0039 7.52734 16.8984 7.7207 16.6963L13.5127 10.8955C13.7236 10.6846 13.8203 10.4473 13.8203 10.1924C13.8203 9.63867 13.416 9.23438 12.8799 9.23438C12.6074 9.23438 12.3613 9.34863 12.1855 9.52441L10.1816 11.5107L7.90527 14.0508L7.97559 12.1523V1.29785C7.97559 0.717773 7.57129 0.313477 7 0.313477Z' fill='currentColor'/>
              </svg>
              Import
            </label>
            <input 
              type='file' 
              id='importFile'
              accept='.txt, .pdf, .docx'
              onChange={handleImport}
              style={{ display: 'none' }}
            />
          </div>
          <div className='submenu__actions-export'>
            <label onClick={handleExport}>
              <svg width='13' height='17' viewBox='0 0 16 20' fill='none' xmlns='http://www.w3.org/2000/svg'>
                <path d='M3.31543 19.1816H12.6846C14.5742 19.1816 15.5498 18.1885 15.5498 16.29V8.30957C15.5498 7.0791 15.3916 6.5166 14.627 5.73438L10.0303 1.06738C9.2832 0.311523 8.66797 0.135742 7.56055 0.135742H3.31543C1.43457 0.135742 0.450195 1.12891 0.450195 3.03613V16.29C0.450195 18.1885 1.43457 19.1816 3.31543 19.1816ZM3.46484 17.4238C2.62109 17.4238 2.19922 16.9844 2.19922 16.1758V3.1416C2.19922 2.3418 2.62109 1.89355 3.47363 1.89355H7.2002V6.6748C7.2002 7.94922 7.82422 8.56445 9.08984 8.56445H13.8008V16.1758C13.8008 16.9844 13.3789 17.4238 12.5264 17.4238H3.46484ZM9.25684 7.02637C8.8877 7.02637 8.72949 6.86816 8.72949 6.50781V2.12207L13.5635 7.02637H9.25684ZM8.77344 15.6221V12.9678L8.70312 11.6055L9.37988 12.3174L10.0391 12.9941C10.1709 13.1348 10.373 13.2227 10.5576 13.2227C10.9619 13.2227 11.2607 12.9414 11.2607 12.5547C11.2607 12.3262 11.1729 12.168 11.0059 12.0186L8.58887 9.80371C8.38672 9.61914 8.21973 9.53125 8 9.53125C7.78027 9.53125 7.61328 9.61914 7.41113 9.80371L4.99414 12.0186C4.82715 12.168 4.73926 12.3262 4.73926 12.5547C4.73926 12.9414 5.03809 13.2227 5.44238 13.2227C5.62695 13.2227 5.8291 13.1348 5.96094 12.9941L6.62012 12.3174L7.29688 11.6055L7.22656 12.9678V15.6221C7.22656 16.0439 7.57812 16.3691 8 16.3691C8.42188 16.3691 8.77344 16.0439 8.77344 15.6221Z' fill='currentColor'/>
              </svg>
              <span>
                Export<br />
                <pre>as txt file</pre>
              </span> 
            </label>
          </div>
        </ul>
        <ul className='submenu__info'>
          <li><a href='https://github.com/Artezi0/note' target='_blank'>
            <svg width='14' height='14' viewBox='0 0 19 19' fill='none' xmlns='http://www.w3.org/2000/svg'>
              <path d='M9.99121 18.7422C14.9746 18.7422 19.0879 14.6289 19.0879 9.6543C19.0879 4.67969 14.9658 0.566406 9.98242 0.566406C5.00781 0.566406 0.90332 4.67969 0.90332 9.6543C0.90332 14.6289 5.0166 18.7422 9.99121 18.7422ZM9.99121 16.9316C5.95703 16.9316 2.73145 13.6885 2.73145 9.6543C2.73145 5.62012 5.95703 2.38574 9.98242 2.38574C14.0166 2.38574 17.2598 5.62012 17.2686 9.6543C17.2773 13.6885 14.0254 16.9316 9.99121 16.9316ZM9.98242 11.1133C10.4658 11.1133 10.7471 10.8408 10.7559 10.3311L10.8877 6.10352C10.9053 5.58496 10.5186 5.20703 9.97363 5.20703C9.42871 5.20703 9.05078 5.57617 9.06836 6.09473L9.19141 10.3311C9.20898 10.832 9.49023 11.1133 9.98242 11.1133ZM9.98242 14.0312C10.5537 14.0312 11.0195 13.6182 11.0195 13.0557C11.0195 12.502 10.5625 12.0889 9.98242 12.0889C9.41113 12.0889 8.94531 12.502 8.94531 13.0557C8.94531 13.6094 9.41992 14.0312 9.98242 14.0312Z' fill='currentColor'/>
            </svg>
            Updates
          </a></li>
          <li><a href='#'>
            <svg width='14' height='14' viewBox='0 0 19 19' fill='none' xmlns='http://www.w3.org/2000/svg'>
              <path d='M9.08789 18.1758C14.0713 18.1758 18.1846 14.0625 18.1846 9.08789C18.1846 4.11328 14.0625 0 9.0791 0C4.10449 0 0 4.11328 0 9.08789C0 14.0625 4.11328 18.1758 9.08789 18.1758ZM9.08789 16.3652C5.05371 16.3652 1.82812 13.1221 1.82812 9.08789C1.82812 5.05371 5.05371 1.81934 9.0791 1.81934C13.1133 1.81934 16.3564 5.05371 16.3652 9.08789C16.374 13.1221 13.1221 16.3652 9.08789 16.3652ZM8.89453 10.8369C9.37793 10.8369 9.68555 10.5557 9.71191 10.1953C9.71191 10.1689 9.71191 10.125 9.7207 10.0898C9.74707 9.6416 10.0547 9.34277 10.626 8.96484C11.4961 8.40234 12.0498 7.89258 12.0498 6.88184C12.0498 5.42285 10.7314 4.5791 9.16699 4.5791C7.66406 4.5791 6.63574 5.26465 6.36328 6.09082C6.31055 6.24023 6.27539 6.38965 6.27539 6.54785C6.27539 6.97852 6.60938 7.24219 7.01367 7.24219C7.53223 7.24219 7.64648 6.97852 7.91895 6.67969C8.2002 6.24023 8.56934 5.98535 9.08789 5.98535C9.78223 5.98535 10.2393 6.38086 10.2393 6.96973C10.2393 7.50586 9.87012 7.7959 9.12305 8.30566C8.49902 8.74512 8.04199 9.19336 8.04199 9.98438V10.0811C8.04199 10.582 8.34961 10.8369 8.89453 10.8369ZM8.87695 13.5352C9.43945 13.5352 9.90527 13.1309 9.90527 12.5684C9.90527 12.0146 9.44824 11.6016 8.87695 11.6016C8.30566 11.6016 7.83984 12.0146 7.83984 12.5684C7.83984 13.1221 8.30566 13.5352 8.87695 13.5352Z' fill='currentColor'/>
            </svg>
            Help
          </a></li>
        </ul>
      </div>
    )
  }

  return (
    <>
      {submenu && <Submenu />}
      <nav className='top'>
        <div className='top__info'>
          {!sidebar &&
          <>
            <button type='button' className='top__info-btn' onClick={handleSide} data-tip data-for='sideTip'>
              <svg width='22' height='22' viewBox='0 0 28 28' fill='none' xmlns='http://www.w3.org/2000/svg'>
                <path d='M14 6.85156C13.2266 5.9375 11.5039 5.12012 9.48242 5.12012C6.78418 5.12012 4.60449 6.51758 4.02441 7.84473V21.0371C4.02441 21.8984 4.58691 22.2324 5.21094 22.2324C5.67676 22.2324 5.94043 22.0918 6.23926 21.8721C6.83691 21.3887 7.8125 20.8262 9.48242 20.8262C11.1611 20.8262 12.3037 21.3887 12.8135 21.8193C13.0947 22.0303 13.4199 22.2324 14 22.2324C14.5801 22.2324 14.8965 22.0127 15.1865 21.8193C15.7314 21.415 16.8389 20.8262 18.5176 20.8262C20.1875 20.8262 21.1807 21.3975 21.7607 21.8721C22.0596 22.0918 22.3232 22.2324 22.7891 22.2324C23.4131 22.2324 23.9756 21.8984 23.9756 21.0371V7.84473C23.3955 6.51758 21.2246 5.12012 18.5176 5.12012C16.4961 5.12012 14.7822 5.9375 14 6.85156ZM5.93164 8.45117C6.16895 7.87109 7.46973 6.88672 9.48242 6.88672C11.4951 6.88672 12.8398 7.87988 13.0508 8.45117V20.0439C12.1455 19.3936 10.8535 19.042 9.48242 19.042C8.10254 19.042 6.81934 19.3936 5.93164 20.0703V8.45117ZM22.0684 8.45117V20.0703C21.1807 19.3936 19.8975 19.042 18.5176 19.042C17.1465 19.042 15.8545 19.3936 14.9492 20.0439V8.45117C15.1602 7.87988 16.5049 6.88672 18.5176 6.88672C20.5303 6.88672 21.8311 7.87109 22.0684 8.45117Z' fill='currentColor'/>
              </svg>
            </button>    
            <ReactTooltip id='sideTip' effect='solid' type='dark' place='right' className='tooltip' backgroundColor='#000' arrowColor='transparent'>
              <span>Toggle Sidebar</span>
            </ReactTooltip>      
          </>
          }
          <p className='top__info-filename' style={filenameStyle}>{filename}</p>
        </div>
        <div className='top__menu'>
          <button type='button' data-tip data-for='readTip' className='top__menu-readonly' onClick={() => isRead(!read)}>
            <svg width='22' height='22' viewBox='0 0 28 28' fill='none' xmlns='http://www.w3.org/2000/svg'>
              <path d='M8.38379 21.8281C11.2051 21.8281 13.3672 18.5234 13.3672 13.6543C13.3672 8.77637 11.2051 5.48926 8.38379 5.48926C5.5625 5.48926 3.40039 8.77637 3.40039 13.6543C3.40039 18.5234 5.5625 21.8281 8.38379 21.8281ZM19.6074 21.8281C22.4287 21.8281 24.5908 18.5234 24.5908 13.6543C24.5908 8.77637 22.4287 5.48926 19.6074 5.48926C16.7949 5.48926 14.624 8.77637 14.624 13.6543C14.624 18.5234 16.7949 21.8281 19.6074 21.8281ZM6.61719 16.6777C8.09375 16.6777 9.07812 15.6582 9.07812 14.1113C9.07812 12.582 8.09375 11.5449 6.61719 11.5449C6.01074 11.5449 5.49219 11.7207 5.08789 12.0283C5.43945 9.02246 6.79297 7.0625 8.38379 7.05371C10.2646 7.04492 11.7939 9.7168 11.7939 13.6543C11.7939 17.5654 10.2646 20.2549 8.38379 20.2637C6.97754 20.2725 5.76465 18.752 5.25488 16.3174C5.63281 16.5547 6.08984 16.6777 6.61719 16.6777ZM17.8408 16.6777C19.3086 16.6777 20.3018 15.6582 20.3018 14.1113C20.3018 12.582 19.3086 11.5449 17.8408 11.5449C17.2256 11.5449 16.707 11.7207 16.2939 12.0283C16.6543 9.02246 18.0078 7.0625 19.6074 7.0625C21.4795 7.0625 23.0088 9.73438 23.0088 13.6543C23.0088 17.5742 21.4795 20.2549 19.6074 20.2549C18.2012 20.2549 16.9795 18.7432 16.4697 16.3174C16.8477 16.5547 17.3135 16.6777 17.8408 16.6777ZM5.92285 13.8037C5.61523 13.751 5.41309 13.3818 5.4834 12.9951C5.5625 12.6084 5.87012 12.3359 6.16895 12.3887C6.48535 12.4502 6.66992 12.8193 6.59082 13.1973C6.52051 13.584 6.23047 13.8564 5.92285 13.8037ZM17.1465 13.8037C16.8301 13.7422 16.6367 13.3818 16.707 12.9951C16.7861 12.6084 17.0762 12.3359 17.3838 12.3887C17.709 12.4414 17.8936 12.8193 17.8145 13.1973C17.7354 13.584 17.4541 13.8564 17.1465 13.8037Z' fill='currentColor'/>
            </svg>
          </button>
          <ReactTooltip id='readTip' effect='solid' type='dark' place='bottom' className='tooltip' backgroundColor='#000' arrowColor='transparent'>
            <span>Read-only</span>
          </ReactTooltip>
          <button type='button' data-tip data-for='subTip' className='top__menu-submenu' onClick={() => isSubmenu(!submenu)}>
            <svg width='22' height='22' viewBox='0 0 28 28' fill='none' xmlns='http://www.w3.org/2000/svg'>
              <path d='M6.16016 9.50586C6.85449 9.50586 7.4082 8.95215 7.4082 8.25781C7.4082 7.57227 6.85449 7.00977 6.16016 7.00977C5.47461 7.00977 4.91211 7.57227 4.91211 8.25781C4.91211 8.95215 5.47461 9.50586 6.16016 9.50586ZM10.291 9.10156H22.2266C22.7012 9.10156 23.0791 8.73242 23.0791 8.25781C23.0791 7.7832 22.71 7.41406 22.2266 7.41406H10.291C9.8252 7.41406 9.44727 7.7832 9.44727 8.25781C9.44727 8.73242 9.81641 9.10156 10.291 9.10156ZM6.16016 14.9111C6.85449 14.9111 7.4082 14.3574 7.4082 13.6631C7.4082 12.9775 6.85449 12.415 6.16016 12.415C5.47461 12.415 4.91211 12.9775 4.91211 13.6631C4.91211 14.3574 5.47461 14.9111 6.16016 14.9111ZM10.291 14.5068H22.2266C22.7012 14.5068 23.0791 14.1377 23.0791 13.6631C23.0791 13.1885 22.71 12.8193 22.2266 12.8193H10.291C9.8252 12.8193 9.44727 13.1885 9.44727 13.6631C9.44727 14.1377 9.81641 14.5068 10.291 14.5068ZM6.16016 20.3164C6.85449 20.3164 7.4082 19.7627 7.4082 19.0684C7.4082 18.3828 6.85449 17.8203 6.16016 17.8203C5.47461 17.8203 4.91211 18.3828 4.91211 19.0684C4.91211 19.7627 5.47461 20.3164 6.16016 20.3164ZM10.291 19.9121H22.2266C22.7012 19.9121 23.0791 19.543 23.0791 19.0684C23.0791 18.5938 22.71 18.2246 22.2266 18.2246H10.291C9.8252 18.2246 9.44727 18.5938 9.44727 19.0684C9.44727 19.543 9.81641 19.9121 10.291 19.9121Z' fill='currentColor'/>
            </svg>
          </button>
          <ReactTooltip id='subTip' effect='solid' type='dark' place='left' className='tooltip' backgroundColor='#000' arrowColor='transparent'>
            <span>Toggle submenu</span>
          </ReactTooltip>
        </div>
      </nav>
    </>
  )
}
